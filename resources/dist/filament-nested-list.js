function L(r,t){if(!(r instanceof t))throw new TypeError("Cannot call a class as a function")}function y(r,t){for(var e=0;e<t.length;e++){var i=t[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(r,I(i.key),i)}}function N(r,t,e){return t&&y(r.prototype,t),e&&y(r,e),Object.defineProperty(r,"prototype",{writable:!1}),r}function d(r,t,e){return t=I(t),t in r?Object.defineProperty(r,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):r[t]=e,r}function u(r){return A(r)||k(r)||C(r)||S()}function A(r){if(Array.isArray(r))return f(r)}function k(r){if(typeof Symbol<"u"&&r[Symbol.iterator]!=null||r["@@iterator"]!=null)return Array.from(r)}function C(r,t){if(r){if(typeof r=="string")return f(r,t);var e=Object.prototype.toString.call(r).slice(8,-1);if(e==="Object"&&r.constructor&&(e=r.constructor.name),e==="Map"||e==="Set")return Array.from(r);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return f(r,t)}}function f(r,t){(t==null||t>r.length)&&(t=r.length);for(var e=0,i=new Array(t);e<t;e++)i[e]=r[e];return i}function S(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function M(r,t){if(typeof r!="object"||r===null)return r;var e=r[Symbol.toPrimitive];if(e!==void 0){var i=e.call(r,t||"default");if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(r)}function I(r){var t=M(r,"string");return typeof t=="symbol"?t:String(t)}var O=function(){function r(t){var e=t.data,i=t.propertyMap,a=i===void 0?{}:i,n=t.renderListItem;L(this,r),d(this,"data",void 0),d(this,"sortedData",void 0),d(this,"sortedDataDomArray",void 0),d(this,"propertyMap",void 0),d(this,"renderListItem",void 0),d(this,"boundGetItemPropProxyName",void 0),this.data=e,this.sortedData=[],this.sortedDataDomArray=[],this.propertyMap=a,this.renderListItem=n,this.boundGetItemPropProxyName=this.getItemPropProxyName.bind(this),this.maybeTransformData()}return N(r,[{key:"addMappingProxyToItem",value:function(e){var i=this;return new Proxy(e,{get:function(n,s,o){return Reflect.get(n,i.boundGetItemPropProxyName(s),o)}})}},{key:"maybeTransformData",value:function(){!Object.keys(this.propertyMap).length||!Array.isArray(this.data)||(this.data=this.data.map(this.addMappingProxyToItem.bind(this)))}},{key:"getItemPropProxyName",value:function(e){return Object.prototype.hasOwnProperty.call(this.propertyMap,e)?this.propertyMap[e]:e}},{key:"isTopLevelItem",value:function(e){return!e.parent}},{key:"sortListItems",value:function(){var e=this,i=u(this.data),a=i.filter(function(s){return e.isTopLevelItem(s)}).sort(function(s,o){return s.order&&o.order?s.order-o.order:0}),n=i.filter(function(s){return!e.isTopLevelItem(s)}).reduce(function(s,o){return o.parent&&(Object.prototype.hasOwnProperty.call(s,o.parent)?s[o.parent].push(o):s[o.parent]=[o]),s},{});return Object.keys(n).forEach(function(s){n[s].sort(function(o,l){return o.order&&l.order?o.order-l.order:0})}),this.sortedData=[].concat(u(a),u(Object.values(n).flat())),this.sortedData}},{key:"addNewItem",value:function(e){var i=e.item,a=e.asLastChild,n=a===void 0?!1:a,s=this.addMappingProxyToItem(i);return Array.isArray(this.data)&&this.data[n?"push":"unshift"](s),this.createItemElement(s)}},{key:"createItemElement",value:function(e){var i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"li",a=e.id,n=e.text,s=document.createElement(i);return s.dataset.id=a,i==="li"&&n&&(s.innerHTML=n),i==="li"&&typeof this.renderListItem=="function"?this.renderListItem(s,e):s}},{key:"elementIsParentOfItem",value:function(e,i){return e.dataset.id==="".concat(i.parent)}},{key:"getParentNodeOfItem",value:function(e,i,a){return e.querySelector("".concat(a,'[data-id="').concat(i.parent,'"]'))}},{key:"elementIsAncestorOfItem",value:function(e,i){return!!this.getParentNodeOfItem(e,i,"li")}},{key:"getDirectListParentOfItem",value:function(e,i){return this.getParentNodeOfItem(e,i,"ol")}},{key:"maybeAppendItemToParentDom",value:function(e){var i=this,a=e.parent,n=this.sortedDataDomArray.find(function(h){return i.elementIsParentOfItem(h,e)||i.elementIsAncestorOfItem(h,e)});if(!n)return!1;var s=this.createItemElement(e),o=this.getDirectListParentOfItem(n,e);if(!o){o=this.createItemElement({id:a},"ol");var l=this.getParentNodeOfItem(n,e,"li")||n;l.appendChild(o)}return o.appendChild(s),!0}},{key:"getListItemsDom",value:function(){var e=this;this.sortedDataDomArray=[];for(var i=[];i.length!==this.sortListItems().length;)i=this.sortedData.reduce(function(a,n){if(!n.id)return a;var s=n.id.toString();if(a.includes(s))return a;var o;if(n.parent)o=e.maybeAppendItemToParentDom(n);else{var l=e.createItemElement(n);e.sortedDataDomArray.push(l),o=!0}return o&&a.push(s),a},i);return this.sortedDataDomArray}},{key:"convertDomToData",value:function(e){var i=this;return Array.from(e?.querySelectorAll("li")||[]).map(function(a){var n,s=a.parentNode,o=s.dataset.id,l=Array.from(s.children).findIndex(function(h){return h===a})+1;return n={},d(n,i.getItemPropProxyName("id"),a.dataset.id),d(n,i.getItemPropProxyName("parent"),o),d(n,i.getItemPropProxyName("order"),l),n})}},{key:"render",value:function(){var e=document.createElement("ol");return this.getListItemsDom().forEach(function(i){return e.appendChild(i)}),e}}]),r}(),D=function(){function r(t){var e=t.actions,i=e===void 0?{}:e,a=t.data,n=t.droppingEdge,s=n===void 0?15:n,o=t.el,l=t.init,h=l===void 0?!0:l,c=t.listClassNames,b=t.listItemClassNames,E=t.nestingLevels,m=t.propertyMap,P=m===void 0?{}:m,T=t.renderListItem;L(this,r),d(this,"actions",void 0),d(this,"classNames",void 0),d(this,"cursor",void 0),d(this,"data",void 0),d(this,"dataEngine",void 0),d(this,"distances",void 0),d(this,"draggedNode",void 0),d(this,"initialised",void 0),d(this,"listClassNames",void 0),d(this,"listEventListeners",void 0),d(this,"listInterface",void 0),d(this,"listItemClassNames",void 0),d(this,"mainListClassName",void 0),d(this,"nestingLevels",void 0),d(this,"placeholderList",void 0),d(this,"placeholderInUse",void 0),d(this,"propertyMap",void 0),d(this,"renderListItem",void 0),d(this,"sortableList",void 0),d(this,"targetedNode",void 0),d(this,"targetNode",void 0),d(this,"wrapper",void 0),this.renderListItem=T;var g=typeof o=="string"?document.querySelector(o):o,v=g instanceof HTMLOListElement||g instanceof HTMLUListElement;this.wrapper=v?void 0:g,this.sortableList=v?g:null,this.data=a,this.listClassNames=this.createListClassNamesArray(c),this.mainListClassName=this.listClassNames[0]||"nested-sort",this.listItemClassNames=this.createListClassNamesArray(b),this.propertyMap=P,this.actions={onDrop:i.onDrop},this.initialised=!1,this.distances={droppingEdge:s},this.classNames={dragged:"ns-dragged",placeholder:"ns-placeholder",targeted:"ns-targeted"},this.listEventListeners={dragover:this.onDragOver.bind(this),dragstart:this.onDragStart.bind(this),dragenter:this.onDragEnter.bind(this),dragend:this.onDragEnd.bind(this),drop:this.onDrop.bind(this)};var p=parseInt(E);this.nestingLevels=isNaN(p)?-1:p,this.listInterface=this.getListInterface(),this.maybeInitDataDom(),this.addListAttributes(),h&&this.initDragAndDrop()}return N(r,[{key:"getListInterface",value:function(){return Array.isArray(this.data)&&this.data.length||this.sortableList instanceof HTMLOListElement?HTMLOListElement:HTMLUListElement}},{key:"getDataEngine",value:function(){return this.dataEngine?this.dataEngine:(this.dataEngine=new O({data:this.data,propertyMap:this.propertyMap,renderListItem:this.renderListItem}),this.dataEngine)}},{key:"createListClassNamesArray",value:function(e){return e?Array.isArray(e)?e:e.split(" "):[]}},{key:"maybeInitDataDom",value:function(){if(Array.isArray(this.data)&&this.data.length&&this.wrapper){var e=this.getDataEngine().render();this.wrapper.innerHTML="",this.wrapper.appendChild(e),this.sortableList=e}}},{key:"getListTagName",value:function(){return this.listInterface===HTMLOListElement?"ol":"ul"}},{key:"getSortableList",value:function(){var e;return this.sortableList instanceof this.listInterface?this.sortableList:(this.sortableList=(e=this.wrapper)===null||e===void 0?void 0:e.querySelector(this.getListTagName()),this.sortableList)}},{key:"addListAttributes",value:function(){var e,i=this,a=this.getSortableList();a&&((e=a.classList).add.apply(e,u(this.listClassNames.concat(this.mainListClassName))),a.querySelectorAll(this.getListTagName()).forEach(function(n){var s;(s=n.classList).add.apply(s,u(i.listClassNames))}),a.querySelectorAll("li").forEach(function(n){var s;(s=n.classList).add.apply(s,u(i.listItemClassNames))}))}},{key:"toggleMainListLifeCycleClassName",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,i=this.getSortableList();if(i){var a="".concat(this.mainListClassName,"--enabled");e?i.classList.add(a):i.classList.remove(a)}}},{key:"toggleListItemAttributes",value:function(){var e,i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;(e=this.getSortableList())===null||e===void 0||e.querySelectorAll("li").forEach(function(a){a.setAttribute("draggable",i.toString())})}},{key:"toggleListEventListeners",value:function(){var e=this,i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,a=this.getSortableList();a&&Object.keys(this.listEventListeners).forEach(function(n){i?a.removeEventListener(n,e.listEventListeners[n]):a.addEventListener(n,e.listEventListeners[n],!1)})}},{key:"initDragAndDrop",value:function(){this.initialised||(this.toggleListEventListeners(),this.initPlaceholderList(),this.toggleListItemAttributes(),this.toggleMainListLifeCycleClassName(),this.initialised=!0)}},{key:"init",value:function(){this.initDragAndDrop()}},{key:"destroy",value:function(){this.toggleListEventListeners(!0),this.toggleListItemAttributes(!1),this.toggleMainListLifeCycleClassName(!1),this.initialised=!1}},{key:"removeClassFromEl",value:function(e,i){i&&i.classList.contains(e)&&i.classList.remove(e)}},{key:"canBeTargeted",value:function(e){return!this.draggedNode||this.draggedNode===e?!1:e.nodeName==="LI"?!this.nestingThresholdReached(e):e instanceof this.listInterface&&e.classList.contains(this.classNames.placeholder)}},{key:"onDragStart",value:function(e){var i;this.draggedNode=e.target,this.draggedNode.classList.add(this.classNames.dragged),(i=e.dataTransfer)===null||i===void 0||i.setData("text","")}},{key:"onDragOver",value:function(e){e.preventDefault(),this.updateCoordination(e),this.managePlaceholderLists()}},{key:"onDragEnter",value:function(e){this.canBeTargeted(e.target)&&(this.removeClassFromEl(this.classNames.targeted,this.targetedNode),this.targetedNode=e.target,this.targetedNode.classList.add(this.classNames.targeted))}},{key:"onDragEnd",value:function(e){e.stopPropagation(),this.removeClassFromEl(this.classNames.dragged,this.draggedNode),this.removeClassFromEl(this.classNames.targeted,this.targetedNode),this.cleanupPlaceholderLists(),delete this.draggedNode,delete this.targetedNode}},{key:"onDrop",value:function(e){e.stopPropagation(),this.maybeDrop(),this.cleanupPlaceholderLists(),typeof this.actions.onDrop=="function"&&this.actions.onDrop(this.getDataEngine().convertDomToData(this.getSortableList()))}},{key:"updateCoordination",value:function(e){this.calcMouseCoords(e),this.calcMouseToTargetedElDist()}},{key:"getDropLocation",value:function(){if(this.canBeDropped()){var e;if(((e=this.targetedNode)===null||e===void 0?void 0:e.nodeName)==="LI")return"before";if(this.targetedNode instanceof this.listInterface)return"inside"}}},{key:"maybeDrop",value:function(){var e=this.getDropLocation();e&&this.dropTheItem(e)}},{key:"dropTheItem",value:function(e){var i,a,n;switch(e){case"before":(i=this.targetedNode)===null||i===void 0||(a=i.parentNode)===null||a===void 0||a.insertBefore(this.draggedNode,this.targetedNode);break;case"inside":(n=this.targetedNode)===null||n===void 0||n.appendChild(this.draggedNode);break}}},{key:"calcMouseCoords",value:function(e){this.cursor={X:e.clientX,Y:e.clientY}}},{key:"calcMouseToTargetedElDist",value:function(){if(this.targetedNode){var e=this.targetedNode.getBoundingClientRect();this.targetNode={X:e.left,Y:e.top};var i=this.targetNode.Y-this.cursor.Y,a=Math.abs(i);this.distances.mouseTo={targetedElTop:i,targetedElTopAbs:a,targetedElBot:a-this.targetedNode.clientHeight}}}},{key:"areNested",value:function(e,i){return!!e&&!!i&&Array.from(i?.querySelectorAll("li")).some(function(a){return a===e})}},{key:"cursorIsIndentedEnough",value:function(){return this.cursor.X-this.targetNode.X>50}},{key:"mouseIsTooCloseToTop",value:function(){var e;return(e=this.distances)!==null&&e!==void 0&&e.droppingEdge?this.cursor.Y-this.targetNode.Y<this.distances.droppingEdge:!1}},{key:"managePlaceholderLists",value:function(){var e=this,i=this.analysePlaceHolderSituation();i.forEach(function(a){switch(a){case"add":e.cleanupPlaceholderLists(),e.addPlaceholderList();break;case"cleanup":e.cleanupPlaceholderLists();break}})}},{key:"targetedNodeIsPlaceholder",value:function(){return this.targetedNode instanceof this.listInterface&&this.targetedNode.classList.contains(this.classNames.placeholder)}},{key:"getNodeDepth",value:function(e){var i=0,a=this.getSortableList(),n=0;if(this.draggedNode){var s=this.draggedNode.querySelectorAll("ul").length||0,o=this.draggedNode.querySelectorAll("ol").length||0;n=s>o?s:o}for(;a!==((l=e)===null||l===void 0?void 0:l.parentElement);){var l,h,c;((h=e)===null||h===void 0?void 0:h.parentElement)instanceof this.listInterface&&i++,e=(c=e)===null||c===void 0?void 0:c.parentElement}return i+n}},{key:"nestingThresholdReached",value:function(e){var i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return this.nestingLevels<0?!1:i?this.getNodeDepth(e)>=this.nestingLevels:this.getNodeDepth(e)>this.nestingLevels}},{key:"analysePlaceHolderSituation",value:function(){if(!this.targetedNode||this.areNested(this.targetedNode,this.draggedNode))return[];var e=[];return!this.cursorIsIndentedEnough()||this.mouseIsTooCloseToTop()?this.targetedNodeIsPlaceholder()||e.push("cleanup"):this.targetedNode!==this.draggedNode&&this.targetedNode.nodeName==="LI"&&!this.targetedNode.querySelectorAll(this.getListTagName()).length&&!this.nestingThresholdReached(this.targetedNode,!0)&&e.push("add"),e}},{key:"animatePlaceholderList",value:function(){var e;this.placeholderInUse.style.minHeight="0",this.placeholderInUse.style.transition="min-height ease .2s",this.placeholderInUse.style.minHeight="".concat((e=this.draggedNode)===null||e===void 0?void 0:e.offsetHeight,"px")}},{key:"addPlaceholderList",value:function(){var e;this.getPlaceholderList(),(e=this.targetedNode)===null||e===void 0||e.appendChild(this.placeholderInUse),this.animatePlaceholderList()}},{key:"targetNodeIsIdentified",value:function(){return!!this.targetedNode}},{key:"targetNodeIsBeingDragged",value:function(){return this.targetNodeIsIdentified()&&this.targetedNode===this.draggedNode}},{key:"targetNodeIsListWithItems",value:function(){return this.targetNodeIsIdentified()&&this.targetedNode instanceof this.listInterface&&!!this.targetedNode.querySelectorAll("li").length}},{key:"canBeDropped",value:function(){return this.targetNodeIsIdentified()&&!this.targetNodeIsBeingDragged()&&!this.targetNodeIsListWithItems()&&!this.areNested(this.targetedNode,this.draggedNode)}},{key:"cleanupPlaceholderLists",value:function(){var e,i=this,a=this.getListTagName(),n=((e=this.getSortableList())===null||e===void 0?void 0:e.querySelectorAll(a))||[];Array.from(n).forEach(function(s){s.querySelectorAll("li").length?s.classList.contains(i.classNames.placeholder)&&(s.classList.remove(i.classNames.placeholder),s.style.minHeight="auto",s.dataset.id=s.parentNode.dataset.id):s.remove()})}},{key:"initPlaceholderList",value:function(){var e;this.placeholderList=document.createElement(this.getListTagName()),(e=this.placeholderList.classList).add.apply(e,[this.classNames.placeholder].concat(u(this.listClassNames)))}},{key:"getPlaceholderList",value:function(){return this.placeholderInUse=this.placeholderList.cloneNode(!0),this.placeholderInUse}},{key:"addNewItem",value:function(e){var i,a=e.item,n=e.asLastChild,s=n===void 0?!1:n,o=this.getDataEngine().addNewItem({item:a,asLastChild:s});return o.setAttribute("draggable",String(this.initialised)),(i=this.getSortableList())===null||i===void 0||i[s?"append":"prepend"](o),{data:this.getDataEngine().convertDomToData(this.getSortableList())}}}]),r}();window.NestedSort=D;
